// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Post {
    id        Int      @id @default(autoincrement())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([name])
}

enum PortionType {
    Parasha
    Daf
    Perek
}

enum Grade {
    Again
    Hard
    Good
    Easy
}

enum Difficulty {
    EASY
    MEDIUM
    HARD
}

model Flashcard {
    id          String     @id @default(cuid())
    portionType PortionType
    portionLabel String
    prompt      String
    answer      String

    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt

    reviews     FlashcardReview[]

    @@index([portionType, portionLabel])
}

// AI-generated flashcards from studied texts
model GeneratedFlashcard {
    id          String     @id @default(cuid())
    
    // Reference to the studied text source
    ref         String     // e.g., "Avot 1:1" or "Avoda Zara 2b:12"
    heRef       String?
    
    // Question and answers (QCM format)
    question    String
    options     String[]   // Array of 3-4 possible answers
    correctAnswer String   // The correct answer from options
    
    // Difficulty and points
    difficulty  Difficulty
    points      Int        // Points earned for correct answer
    
    // Context from Sefaria
    contextText String?    // Full text context for segmented sources
    
    // Generation metadata
    generatedAt DateTime   @default(now())
    isActive    Boolean    @default(true)
    
    // Relations
    userCompletions UserFlashcardCompletion[]
    
    @@index([ref])
    @@index([difficulty])
    @@index([generatedAt])
}

// Track which users completed which flashcards
model UserFlashcardCompletion {
    id            String   @id @default(cuid())
    userId        String
    user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    flashcardId   String
    flashcard     GeneratedFlashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
    
    wasCorrect    Boolean
    pointsEarned  Int
    completedAt   DateTime @default(now())
    
    @@unique([userId, flashcardId])
    @@index([userId, completedAt])
    @@index([flashcardId])
}

// Track flashcard generation jobs
model FlashcardGenerationJob {
    id          String   @id @default(cuid())
    ref         String   @unique // Ensure we don't generate twice for same ref
    status      FlashcardJobStatus @default(PENDING)
    error       String?
    attempts    Int      @default(0)
    
    createdAt   DateTime @default(now())
    completedAt DateTime?
    
    @@index([status, createdAt])
}

enum FlashcardJobStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
}

model FlashcardReview {
    id          String   @id @default(cuid())
    flashcardId String
    flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

    // scheduling (simple SM-2-ish)
    dueAt       DateTime @default(now())
    intervalDays Int     @default(0)
    ease        Float   @default(2.5)
    reps        Int     @default(0)

    lastGrade   Grade?
    lastReviewedAt DateTime?

    createdAt   DateTime @default(now())
    updatedAt   DateTime @default(now())

    @@index([dueAt])
    @@index([flashcardId])
}

// ==================== GAMIFICATION MODELS ====================

// NextAuth.js Models
model User {
    id            String    @id @default(cuid())
    name          String?
    email         String    @unique
    emailVerified DateTime?
    image         String?
    password      String?   // For credentials login
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // NextAuth relations
    accounts Account[]
    sessions Session[]
    
    // App relations
    streak       Streak?
    points       Points[]
    level        Level?
    goals        Goal[]
    studySessions StudySession[]
    studiedTexts StudiedText[]
    flashcardCompletions UserFlashcardCompletion[]

    @@index([email])
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@index([userId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

model Streak {
    id              String    @id @default(cuid())
    userId          String    @unique
    user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
    currentStreak   Int       @default(0)
    longestStreak   Int       @default(0)
    lastStudyDate   DateTime?
  
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt

    @@index([userId])
}

model Points {
    id        String   @id @default(cuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
    action    PointAction
    points    Int
    metadata  Json?    // Optional: store context like { ref: "Genesis 1:1" }
  
    earnedAt  DateTime @default(now())

    @@index([userId, earnedAt])
    @@index([userId, action])
}

enum PointAction {
    STUDY_TEXT        // Reading a text
    COMPLETE_FLASHCARD // Reviewing a flashcard
    STREAK_BONUS      // Daily streak bonus
    GOAL_COMPLETED    // Completing a goal
    LEVEL_UP          // Leveling up bonus
    FIRST_STUDY_TODAY // First study of the day
}

model Level {
    id           String   @id @default(cuid())
    userId       String   @unique
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
    currentLevel Int      @default(1)
    totalPoints  Int      @default(0)
  
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@index([userId])
}

model Goal {
    id          String     @id @default(cuid())
    userId      String
    user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
    type        GoalType
    target      Int        // e.g., 5 texts, 10 flashcards
    progress    Int        @default(0)
    period      GoalPeriod
  
    startDate   DateTime   @default(now())
    endDate     DateTime?
    completedAt DateTime?
  
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @updatedAt

    @@index([userId, period])
    @@index([userId, completedAt])
}

enum GoalType {
    TEXTS_STUDIED
    FLASHCARDS_REVIEWED
    STUDY_MINUTES
    STREAK_DAYS
}

enum GoalPeriod {
    DAILY
    WEEKLY
    MONTHLY
    CUSTOM
}

model StudySession {
    id        String   @id @default(cuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
    date      DateTime @db.Date // Just the date, no time
    duration  Int      @default(0) // Minutes studied
  
    textsRead      Int @default(0)
    flashcardsReviewed Int @default(0)
  
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, date])
    @@index([userId, date])
}

model StudiedText {
    id      String  @id @default(cuid())
    userId  String
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Sefaria reference
    ref     String
    heRef   String?
    url     String?

    // Snapshot for display
    title   String?
    snippet String?

    createdAt DateTime @default(now())

    @@unique([userId, ref])
    @@index([userId, createdAt])
}
