// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

enum PortionType {
  Parasha
  Daf
  Perek
}

enum Grade {
  Again
  Hard
  Good
  Easy
}

model Flashcard {
  id           String      @id @default(cuid())
  portionType  PortionType
  portionLabel String
  prompt       String
  answer       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews FlashcardReview[]

  @@index([portionType, portionLabel])
}

model FlashcardReview {
  id          String    @id @default(cuid())
  flashcardId String
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  // scheduling (simple SM-2-ish)
  dueAt        DateTime @default(now())
  intervalDays Int      @default(0)
  ease         Float    @default(2.5)
  reps         Int      @default(0)

  lastGrade      Grade?
  lastReviewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([dueAt])
  @@index([flashcardId])
}

// ==================== GAMIFICATION MODELS ====================

model User {
  id        String   @id @default(cuid())
  userKey   String   @unique // localStorage identifier until auth exists
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  streak        Streak?
  points        Points[]
  level         Level?
  goals         Goal[]
  studySessions StudySession[]
  studiedTexts  StudiedText[]

  @@index([userKey])
}

model Streak {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastStudyDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Points {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   PointAction
  points   Int
  metadata Json? // Optional: store context like { ref: "Genesis 1:1" }

  earnedAt DateTime @default(now())

  @@index([userId, earnedAt])
  @@index([userId, action])
}

enum PointAction {
  STUDY_TEXT // Reading a text
  COMPLETE_FLASHCARD // Reviewing a flashcard
  STREAK_BONUS // Daily streak bonus
  GOAL_COMPLETED // Completing a goal
  LEVEL_UP // Leveling up bonus
  FIRST_STUDY_TODAY // First study of the day
}

model Level {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentLevel Int @default(1)
  totalPoints  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Goal {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     GoalType
  target   Int // e.g., 5 texts, 10 flashcards
  progress Int        @default(0)
  period   GoalPeriod

  startDate   DateTime  @default(now())
  endDate     DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, period])
  @@index([userId, completedAt])
}

enum GoalType {
  TEXTS_STUDIED
  FLASHCARDS_REVIEWED
  STUDY_MINUTES
  STREAK_DAYS
}

enum GoalPeriod {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

model StudySession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date     DateTime @db.Date // Just the date, no time
  duration Int      @default(0) // Minutes studied

  textsRead          Int @default(0)
  flashcardsReviewed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

model StudiedText {
  id      String  @id @default(cuid())
  userKey String // Keep for backward compatibility
  userId  String?
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Sefaria reference
  ref   String
  heRef String?
  url   String?

  // Snapshot for display
  title   String?
  snippet String?

  createdAt DateTime @default(now())

  @@unique([userKey, ref])
  @@index([userKey, createdAt])
  @@index([userId, createdAt])
}
